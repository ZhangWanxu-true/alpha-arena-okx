# 🎛️ 宝塔面板部署指南

## 📋 部署说明

宝塔面板的Python项目管理器只支持单一入口文件，因此我们创建了 `app.py` 作为统一入口，它集成了：

- ✅ Web监控界面
- ✅ 交易机器人
- ✅ 健康监控（进程守护）
- ✅ API接口

---

## 🚀 快速部署

### 前置要求

1. **服务器**: 1核1G以上，推荐2核2G
2. **系统**: CentOS 7+ / Ubuntu 18.04+
3. **宝塔面板**: 7.0+
4. **Python版本**: 3.8 - 3.11（推荐3.10）

---

## 📝 详细步骤

### 步骤1: 安装宝塔面板

如果还没有安装宝塔面板：

```bash
# CentOS/RHEL
yum install -y wget && wget -O install.sh https://download.bt.cn/install/install_6.0.sh && sh install.sh

# Ubuntu/Debian
wget -O install.sh https://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh
```

安装完成后记录面板地址、用户名和密码。

---

### 步骤2: 安装Python管理器

1. 登录宝塔面板
2. 进入 **软件商店**
3. 搜索 **"Python项目管理器"**
4. 点击 **安装**

![Python项目管理器](https://img.shields.io/badge/宝塔-Python项目管理器-blue)

---

### 步骤3: 安装Python版本

1. 进入 **Python项目管理器**
2. 点击 **版本管理**
3. 安装 **Python 3.10**（推荐）
4. 等待安装完成

---

### 步骤4: 上传项目文件

#### 方式一：通过宝塔文件管理器

1. 进入 **文件** 管理
2. 创建项目目录（例如：`/www/wwwroot/btc-trading-bot`）
3. 上传所有项目文件
4. 确保包含以下文件：
   ```
   /www/wwwroot/btc-trading-bot/
   ├── app.py              ⭐ 入口文件
   ├── deepseekok2.py
   ├── requirements.txt
   ├── .env                ⭐ 需要创建
   ├── templates/
   └── static/
   ```

#### 方式二：通过Git（推荐）

```bash
# SSH连接到服务器
cd /www/wwwroot/
git clone <你的仓库地址> btc-trading-bot
cd btc-trading-bot
```

---

### 步骤5: 配置环境变量

在项目根目录创建 `.env` 文件：

```bash
# 使用宝塔文件管理器或命令行
cd /www/wwwroot/btc-trading-bot/
nano .env
```

填入以下内容：

```env
# AI模型选择 (deepseek 或 qwen)
AI_PROVIDER=deepseek

# DeepSeek API
DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxxxxx

# OKX交易所API
OKX_API_KEY=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
OKX_SECRET=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
OKX_PASSWORD=xxxxxxxx

# 端口（可选，默认8080）
PORT=8080
```

**重要**: 确保 `.env` 文件权限正确：

```bash
chmod 600 .env
```

---

### 步骤6: 创建Python项目

1. 进入 **Python项目管理器**
2. 点击 **添加项目**
3. 填写配置：

| 配置项 | 值 | 说明 |
|--------|-----|------|
| **项目名称** | `btc-trading-bot` | 自定义 |
| **项目路径** | `/www/wwwroot/btc-trading-bot` | 项目目录 |
| **Python版本** | `3.10` | 已安装的版本 |
| **启动文件** | `app.py` | ⭐ 入口文件 |
| **端口** | `8080` | Web访问端口 |
| **运行方式** | `gunicorn` | 推荐 |
| **进程数** | `1` | 不要多进程 |
| **线程数** | `4` | 根据CPU调整 |

4. 点击 **提交**

---

### 步骤7: 安装依赖

项目创建后，宝塔会自动安装依赖。如果需要手动安装：

1. 在Python项目管理器中找到项目
2. 点击 **模块** 按钮
3. 点击 **从requirements.txt安装**

或者通过SSH：

```bash
cd /www/wwwroot/btc-trading-bot/

# 使用项目虚拟环境
source /www/server/pyporject_evn/btc-trading-bot/bin/activate

# 安装依赖
pip install -r requirements.txt
```

---

### 步骤8: 启动项目

1. 在Python项目管理器中找到项目
2. 点击 **启动** 按钮
3. 查看日志确认启动成功

成功标志：
```
🚀 BTC交易机器人启动 (宝塔面板部署)
🌐 Web管理界面启动
📊 访问地址: http://localhost:8080
```

---

### 步骤9: 配置防火墙

如果需要外部访问，需要开放端口：

1. 进入 **安全**
2. 添加规则：
   - 端口：`8080`
   - 类型：`放行`
   - 备注：`BTC交易机器人`

---

### 步骤10: 访问监控面板

浏览器访问：

```
http://你的服务器IP:8080
```

或配置域名访问（见下文）。

---

## 🌐 配置域名访问（可选）

### 使用Nginx反向代理

1. 进入 **网站**
2. 点击 **添加站点**
3. 填写域名（例如：`btc-bot.yourdomain.com`）
4. 创建站点后，点击 **设置**
5. 进入 **反向代理**
6. 添加代理：

```
目标URL: http://127.0.0.1:8080
发送域名: $host
```

7. 保存并重启Nginx

现在可以通过域名访问：`http://btc-bot.yourdomain.com`

### 配置SSL（可选）

1. 在站点设置中进入 **SSL**
2. 选择 **Let's Encrypt**
3. 申请免费证书
4. 强制HTTPS

---

## 📊 监控和管理

### 查看日志

在Python项目管理器中：

1. 找到项目
2. 点击 **日志** 按钮
3. 查看实时日志

或通过SSH：

```bash
# 应用日志
tail -f /www/wwwroot/btc-trading-bot/app.log

# 宝塔日志
tail -f /www/server/panel/logs/error.log
```

### 重启项目

1. 在Python项目管理器中
2. 点击 **重启** 按钮

或通过SSH：

```bash
# 通过宝塔命令
bt python stop btc-trading-bot
bt python start btc-trading-bot
```

### 查看进程状态

```bash
# 查看Python进程
ps aux | grep app.py

# 查看端口占用
netstat -tunlp | grep 8080
```

---

## 🔧 高级配置

### 修改运行参数

编辑项目配置文件：

```bash
# 宝塔项目配置文件位置
/www/server/panel/pyproject/btc-trading-bot/config.json
```

或在宝塔面板中修改：

1. Python项目管理器 → 项目 → **设置**
2. 修改进程数、线程数、启动参数等

### 环境变量管理

在宝塔项目配置中添加环境变量：

1. 进入项目 **设置**
2. 找到 **环境变量**
3. 添加需要的变量

### 使用Supervisor（可选）

如果不使用宝塔的Python管理器，可以用Supervisor：

1. 安装Supervisor：
   ```bash
   pip install supervisor
   ```

2. 创建配置文件 `/etc/supervisor/conf.d/btc-trading-bot.conf`:

```ini
[program:btc-trading-bot]
directory=/www/wwwroot/btc-trading-bot
command=/www/server/pyporject_evn/btc-trading-bot/bin/python app.py
user=www
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/www/wwwroot/btc-trading-bot/supervisor.log
environment=PATH="/www/server/pyporject_evn/btc-trading-bot/bin"
```

3. 重载配置：
   ```bash
   supervisorctl reread
   supervisorctl update
   supervisorctl start btc-trading-bot
   ```

---

## 🐛 常见问题

### 1. 项目启动失败

**现象**: 点击启动后立即停止

**排查步骤**:

```bash
# 1. 查看日志
tail -f /www/wwwroot/btc-trading-bot/app.log

# 2. 手动运行测试
cd /www/wwwroot/btc-trading-bot/
source /www/server/pyporject_evn/btc-trading-bot/bin/activate
python app.py

# 3. 检查端口占用
netstat -tunlp | grep 8080
```

**常见原因**:
- `.env` 配置错误
- 端口被占用
- 依赖安装不完整
- Python版本不兼容

---

### 2. 依赖安装失败

**现象**: `ModuleNotFoundError`

**解决**:

```bash
cd /www/wwwroot/btc-trading-bot/
source /www/server/pyporject_evn/btc-trading-bot/bin/activate

# 更新pip
pip install --upgrade pip

# 安装依赖
pip install -r requirements.txt

# 检查安装
pip list
```

---

### 3. 无法访问Web界面

**检查清单**:

- [ ] 项目是否启动成功
- [ ] 端口是否开放（防火墙/安全组）
- [ ] 监听地址是否正确（应该是 0.0.0.0）
- [ ] 服务器IP是否正确

**测试**:

```bash
# 本地测试
curl http://localhost:8080/api/health

# 远程测试
curl http://你的服务器IP:8080/api/health
```

---

### 4. AI决策没有输出

**现象**: Web界面数据不更新

**检查**:

```bash
# 查看日志
tail -f /www/wwwroot/btc-trading-bot/app.log

# 检查健康状态
curl http://localhost:8080/api/health
```

**说明**: `app.py` 集成了健康监控，会自动检测并重启异常线程。

---

### 5. 内存占用过高

**原因**: 长时间运行累积数据

**解决**:

1. 定期重启（每周一次）
2. 清理日志文件
3. 增加服务器内存

设置定时重启：

1. 宝塔面板 → **计划任务**
2. 添加任务：
   - 类型：Shell脚本
   - 执行周期：每周日凌晨3点
   - 脚本内容：
   ```bash
   bt python restart btc-trading-bot
   ```

---

## 📈 性能优化

### 1. 使用Gunicorn（推荐）

在宝塔项目配置中：
- 运行方式：`gunicorn`
- Worker数：`1`（不要多进程，会导致交易重复）
- 线程数：`4`

### 2. 日志轮转

编辑 `app.py`，添加日志轮转：

```python
from logging.handlers import RotatingFileHandler

handler = RotatingFileHandler(
    'app.log',
    maxBytes=10*1024*1024,  # 10MB
    backupCount=5,
    encoding='utf-8'
)
```

### 3. 使用Redis缓存（可选）

如果需要高性能，可以使用Redis存储实时数据。

---

## 🔒 安全建议

### 1. 限制访问IP

在Nginx配置中添加：

```nginx
location / {
    allow 你的IP;
    deny all;
    proxy_pass http://127.0.0.1:8080;
}
```

### 2. 添加HTTP认证

宝塔面板 → 网站 → 设置 → 访问限制 → 密码访问

### 3. 使用HTTPS

强制SSL，避免API密钥泄露。

### 4. 定期备份

1. 宝塔面板 → **计划任务**
2. 添加备份任务（每天）
3. 备份网站和数据库

---

## 📝 项目结构

```
/www/wwwroot/btc-trading-bot/
├── app.py                    ⭐ 宝塔入口文件（新增）
├── deepseekok2.py           # 交易核心逻辑
├── web_server.py            # 原Web服务（本地用）
├── process_guardian.py      # 原守护程序（本地用）
├── requirements.txt         # 依赖列表
├── .env                     # 配置文件
├── app.log                  # 应用日志
├── templates/               # HTML模板
├── static/                  # 静态资源
└── 宝塔面板部署指南.md      # 本文件
```

---

## 🎯 对比：本地部署 vs 宝塔部署

| 特性 | 本地部署 | 宝塔部署 |
|------|----------|----------|
| **入口文件** | `web_server.py` | `app.py` |
| **守护机制** | 独立进程 | 集成线程 |
| **管理方式** | 命令行 | Web界面 |
| **日志查看** | 文件 | 宝塔面板 |
| **自动重启** | 手动 | 自动 |
| **适用场景** | 开发测试 | 生产部署 |

---

## 🆘 获取帮助

遇到问题时：

1. **查看日志**: `/www/wwwroot/btc-trading-bot/app.log`
2. **测试API**: `curl http://localhost:8080/api/health`
3. **检查进程**: `ps aux | grep app.py`
4. **查看端口**: `netstat -tunlp | grep 8080`
5. **手动运行**: 激活虚拟环境后 `python app.py`

---

## 🎉 部署完成检查清单

- [ ] 宝塔面板已安装
- [ ] Python项目管理器已安装
- [ ] Python 3.10已安装
- [ ] 项目文件已上传
- [ ] `.env` 配置文件已创建
- [ ] 依赖已安装完成
- [ ] 项目启动成功
- [ ] Web界面可以访问
- [ ] 防火墙端口已开放
- [ ] AI连接状态正常
- [ ] 交易机器人运行正常

---

**祝部署顺利！** 🚀

如有问题，查看 `app.log` 日志或联系技术支持。

